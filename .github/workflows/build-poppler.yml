name: Build Poppler Lambda Layer

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Poppler and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils libpoppler-dev zip
      
      - name: Create layer structure
        run: |
          mkdir -p layer/python/bin
          mkdir -p layer/lib
          
          # Copy poppler binaries
          cp /usr/bin/pdfinfo layer/python/bin/
          cp /usr/bin/pdftoppm layer/python/bin/
          cp /usr/bin/pdftotext layer/python/bin/
          cp /usr/bin/pdftops layer/python/bin/
          cp /usr/bin/pdfimages layer/python/bin/
          
          # Copy required libraries
          cp /usr/lib/x86_64-linux-gnu/libpoppler.so* layer/lib/ || true
          cp /usr/lib/x86_64-linux-gnu/libjpeg.so* layer/lib/ || true
          cp /usr/lib/x86_64-linux-gnu/libpng.so* layer/lib/ || true
          cp /usr/lib/x86_64-linux-gnu/libtiff.so* layer/lib/ || true
          cp /usr/lib/x86_64-linux-gnu/libopenjp2.so* layer/lib/ || true
          
          # Make binaries executable
          chmod +x layer/python/bin/*
      
      - name: Create zip file
        run: |
          cd layer
          zip -r9 ../poppler-layer.zip .
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: poppler-layer
          path: poppler-layer.zip
